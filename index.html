<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aquarium Log</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body, button, select, input, label, p, div, h1, h2, h3, h4, h5, h6 {
            font-family: 'Noto Serif', serif;
        }
        body {
            background-color: #282828; /* Dark Grey from theme */
            color: #3c3c3c; /* Dark text for panels */
        }
        .retro-panel {
            background-color: #EADBC8; /* Beige from theme */
            border: 1px solid #5a534a;
            border-radius: 4px;
            box-shadow: inset 0 1px 1px rgba(255,255,255,0.5), 0 2px 3px rgba(0,0,0,0.3);
            position: relative;
            clip-path: polygon(0 0, calc(100% - 15px) 0, 100% 15px, 100% 100%, 0 100%);
            padding: 1rem;
        }
        
        .retro-btn {
            background-color: #3c3c3c; /* Dark Grey from theme */
            border: 1px solid #1e1e1e;
            color: #EADBC8; /* Beige text */
            transition: all 0.2s ease;
            border-radius: 3px;
            box-shadow: inset 0 1px 1px #5c5c5c, 0 1px 1px #111;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 0.5rem 1rem;
            position: relative;
            height: 42px; /* Fixed height for consistent sizing */
            padding-left: 24px; /* Space for the light bar */
        }
        /* The indicator light bar */
        .retro-btn::before {
            content: '';
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 22px;
            background-color: #2a2727; 
            border: 1px solid #1e1e1e;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
            border-radius: 2px;
            transition: all 0.2s ease;
        }
        .retro-btn:hover {
            background-color: #4c4c4c;
        }
        .retro-btn.active::before {
            background-color: #f59e0b; /* Amber */
        }
        .retro-btn.no-light {
            padding-left: 1rem;
        }
        .retro-btn.no-light::before {
            display: none;
        }
        .day-cell {
            position: relative;
            padding-bottom: 8px;
        }
        .day-cell.selected {
            background-color: #4c4c4c;
            outline: 2px solid #f59e0b; /* Amber */
            outline-offset: -2px;
        }
        .day-cell.today {
           color: #C35843; /* Rusty Red */
           font-weight: 700;
           border-bottom: 2px solid #C35843;
        }
        .log-dots {
            position: absolute;
            bottom: 2px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 3px;
        }
        .log-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            border: 1px solid rgba(0,0,0,0.2);
        }
        .dot-dose { background-color: #D87D25; } /* Orange */
        .dot-wc { background-color: #2563eb; } 
        .dot-wq { background-color: #16a34a; } 
        .priority-action {
            border-left: 4px solid #C35843; /* Rusty Red */
        }
        .recommendation-action {
            border-left: 4px solid #D87D25; /* Orange */
        }
        input[type="number"] {
            background-color: #3c3c3c;
            color: #EADBC8;
            border: 1px solid #1e1e1e;
            border-radius: 3px;
        }
    </style>
</head>
<body>

    <div class="container mx-auto p-4 max-w-2xl">
        <header class="text-center mb-6">
            <h1 class="text-3xl font-bold tracking-wide" style="color: #EADBC8;">Aquarium Log</h1>
            <p id="streak-counter" class="text-stone-400 font-semibold"></p>
        </header>

        <!-- Monthly Calendar Panel -->
        <div id="calendar-panel" class="retro-panel mb-6">
            <div id="calendar-header" class="flex justify-between items-center mb-3">
                <button id="prev-month-btn" class="retro-btn no-light !p-2 !h-auto">&lt;</button>
                <h2 id="month-year-title" class="text-xl font-bold text-center text-zinc-900"></h2>
                <button id="next-month-btn" class="retro-btn no-light !p-2 !h-auto">&gt;</button>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7 gap-1 text-center">
                <!-- Calendar will be generated by JavaScript -->
            </div>
        </div>

        <!-- Algae Alert Panel -->
        <div id="algae-panel" class="retro-panel mb-6">
             <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <h2 class="text-xl font-bold text-center text-zinc-900">System Status</h2>
                <button id="algae-btn" class="retro-btn w-full sm:w-auto">Algae Present</button>
            </div>
        </div>

        <!-- Water Quality Panel -->
        <div id="wq-panel" class="retro-panel mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <h2 class="text-xl font-bold text-center text-zinc-900">Water Quality</h2>
                <div class="flex gap-2 w-full sm:w-auto">
                    <button id="log-wq-btn" class="retro-btn w-full">Log Parameters</button>
                    <button id="analyze-btn" class="retro-btn active w-full font-bold">Analyse Health</button>
                </div>
            </div>
            <div id="water-quality-inputs-container" class="mt-4 pt-4 border-t border-stone-300 hidden">
                <div id="water-quality-inputs" class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-sm"></div>
                <h3 class="text-lg font-bold text-zinc-800 mt-4 mb-2">Advanced Parameters</h3>
                <div id="advanced-wq-inputs" class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm"></div>
            </div>
        </div>

        <!-- System Analysis Panel -->
        <div id="analysis-container" class="mb-6"></div>

        <!-- Water Change Panel -->
        <div id="wc-panel" class="retro-panel mb-6">
            <h2 id="water-change-title" class="text-xl font-bold mb-3 text-center text-zinc-900">Water Change</h2>
            <div class="flex items-center justify-center gap-2">
                <label for="wc-input" class="font-semibold">Water Added:</label>
                <input type="number" id="wc-input" min="0" step="0.01" class="w-24 p-2 text-center rounded">
                <span class="font-semibold">litres</span>
            </div>
        </div>

        <!-- Action Items -->
        <div id="protocols-panel" class="mb-6">
            <h2 id="dosing-day-title" class="text-2xl font-bold text-center mb-4" style="color: #EADBC8;">Today's Tasks</h2>
            <div id="system-recommendations-container" class="space-y-3 mb-4"></div>
            <div id="priority-actions-container" class="space-y-3 mb-4"></div>
            <div id="treatment-cards" class="space-y-3"></div>
        </div>
        
        <!-- Chemical Reference Section -->
        <div id="chem-ref-panel" class="retro-panel mt-6">
            <button id="chem-ref-toggle" class="w-full text-left p-0 focus:outline-none">
                <div class="flex justify-between items-center">
                    <h2 class="text-xl font-bold text-zinc-900">Chemical Reference</h2>
                    <svg id="chem-ref-arrow" class="w-6 h-6 transform transition-transform text-zinc-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </div>
            </button>
            <div id="chem-ref-content" class="pt-4 mt-4 border-t border-stone-300 hidden space-y-4">
                <!-- Chemical details will be generated by JavaScript -->
            </div>
        </div>

        <!-- Reset Button -->
        <div id="reset-panel" class="text-center mt-8">
            <button id="reset-button" class="retro-btn no-light font-bold" style="background-color: #C35843; color: #EADBC8; border-color: #a14836;">
                Reset Day's Log
            </button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const elements = {
                calendarGrid: document.getElementById('calendar-grid'),
                monthYearTitle: document.getElementById('month-year-title'),
                prevMonthBtn: document.getElementById('prev-month-btn'),
                nextMonthBtn: document.getElementById('next-month-btn'),
                cards: document.getElementById('treatment-cards'),
                wcInput: document.getElementById('wc-input'),
                waterChangeTitle: document.getElementById('water-change-title'),
                dosingDayTitle: document.getElementById('dosing-day-title'),
                wqInputsContainer: document.getElementById('water-quality-inputs-container'),
                wqInputs: document.getElementById('water-quality-inputs'),
                logWqBtn: document.getElementById('log-wq-btn'),
                advancedWqInputs: document.getElementById('advanced-wq-inputs'),
                priorityActions: document.getElementById('priority-actions-container'),
                systemRecommendations: document.getElementById('system-recommendations-container'),
                resetButton: document.getElementById('reset-button'),
                chemRefToggle: document.getElementById('chem-ref-toggle'),
                chemRefContent: document.getElementById('chem-ref-content'),
                chemRefArrow: document.getElementById('chem-ref-arrow'),
                analyzeBtn: document.getElementById('analyze-btn'),
                analysisContainer: document.getElementById('analysis-container'),
                streakCounter: document.getElementById('streak-counter'),
                algaeBtn: document.getElementById('algae-btn'),
            };

            // --- Constants & State ---
            const TANK_SIZE_GALLONS = 3;
            const TANK_SIZE_LITRES = TANK_SIZE_GALLONS * 3.78541;
            const DROPS_PER_ML = 20;
            const MG_PER_L_TO_DH = 17.86;
            const DAYS = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const TODAY = new Date();
            TODAY.setHours(0, 0, 0, 0);

            let state = {
                currentDate: new Date(TODAY),
                selectedDate: new Date(TODAY),
                logData: {},
                firstLogDate: null
            };

            // --- Data Definitions ---
            const formatDose = (ml) => {
                if (isNaN(ml) || ml <= 0) return 'N/A';
                const drops = Math.round(ml * DROPS_PER_ML);
                return `${ml.toFixed(2)} mL (~${drops} drops)`;
            };
            
            const formatGrams = (g) => {
                 if (isNaN(g) || g <= 0) return 'N/A';
                 return `${g.toFixed(2)} g`;
            }

            const TREATMENTS = [
                { name: 'Flourish', dose: () => formatDose( (5 / 250) * TANK_SIZE_LITRES ), schedule: { type: 'weekly', days: [4] }, directions: 'Use 1 capful (5 mL) for each 250 L (60 US gallons) once or twice a week. For smaller doses, each cap thread is approx. 1 mL. Refrigeration is recommended 3 months after opening.' },
                { name: 'Trace', dose: () => formatDose( (5 / 80) * TANK_SIZE_LITRES ), schedule: { type: 'weekly', days: [2, 6] }, directions: 'Use 1 capful (5 mL) for every 80 L (20 US gallons) twice a week. When using in conjunction with Flourish®, dose on alternate days.' },
                { name: 'Excel', dose: (isWC, wcVolume) => formatDose(isWC && (wcVolume / TANK_SIZE_LITRES) >= 0.4 ? (5 / 40) * TANK_SIZE_LITRES : (5 / 200) * TANK_SIZE_LITRES), schedule: { type: 'alternate_day' }, directions: 'On initial use or after a major (> 40%) water change, use 1 capful (5 mL) for every 40 L (10 US gallons). Thereafter use 1 capful for every 200 L (50 US gallons) daily or every other day.' },
                { name: 'Iron', dose: () => formatDose( (5 / 200) * TANK_SIZE_LITRES ), schedule: { type: 'weekly', days: [5] }, directions: 'Use 1 capful (5 mL) for each 200 L (50 US gallons) or as required to maintain about 0.10 mg/L iron.' },
                { name: 'Nitrogen', dose: () => formatDose( ((2.5 / 160) * TANK_SIZE_LITRES) * 0.75 ), schedule: { type: 'weekly', days: [1, 4] }, directions: 'Use 2.5 mL (half a cap) for each 160 L (40 US gallons) twice a week or as needed in response to signs of nitrogen deficiency (e.g. stunted growth, chlorosis).' },
                { name: 'Prime', dose: (isWC, wcVolume) => { if (!isWC || wcVolume <= 0) return 'N/A'; return formatDose((5 / 200) * wcVolume); }, schedule: { type: 'water_change' }, directions: 'Use 1 capful (5 mL) for each 200 L (50 US gallons) of new water. For smaller volumes, each cap thread is approx. 1 mL. Best if added to new water before adding to aquarium.' },
                { name: 'Stability', dose: (isWC) => isWC ? formatDose((5 / 80) * TANK_SIZE_LITRES) : 'N/A', schedule: { type: 'water_change_monthly' }, directions: 'For optimum biofilter performance use 1 capful (5 mL) for each 80 L (20 US gallons) once a month with a water change.' },
                { name: 'Alkaline Buffer', dose: () => formatGrams( (6 / 80) * TANK_SIZE_LITRES ), schedule: { type: 'manual' }, directions: 'To increase pH, use 1 teaspoon (6 g) for every 80 L (20 US gallons) daily until desired pH is reached (this dose raises alkalinity by about 1 meq/L (2.8 dKH)).' }
            ];

            const WQ_PARAMS = {
                pH: { label: 'pH', values: ['Not Tested', '6.0', '6.4', '6.8', '7.0', '7.2', '7.6', '8.0'] },
                Ammonia: { label: 'Ammonia', values: ['Not Tested', '0', '0.25', '0.5', '1.0', '2.0', '4.0'], unit: 'ppm' },
                Nitrite: { label: 'Nitrite', values: ['Not Tested', '0', '0.25', '0.5', '1.0', '2.0', '5.0'], unit: 'ppm' },
                Nitrate: { label: 'Nitrate', values: ['Not Tested', '0', '5', '10', '20', '40', '80'], unit: 'ppm' }
            };
            
            const ADVANCED_WQ_PARAMS = {
                GH: { label: 'GH', unit: 'mg/L' },
                KH: { label: 'KH', unit: 'mg/L' },
                TA: { label: 'TA', unit: 'ppm' }
            };

            // --- Date & Data Helpers ---
            const toISODateString = (date) => date.toISOString().split('T')[0];
            const formatDate = (date) => {
                const day = String(date.getDate()).padStart(2, '0');
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${day}.${month}.${year}`;
            };

            function findFirstLogDate() {
                const dates = Object.keys(state.logData);
                if (dates.length === 0) return null;
                dates.sort();
                return new Date(dates[0] + 'T12:00:00');
            }

            function pruneOldData() {
                const twoMonthsAgo = new Date();
                twoMonthsAgo.setMonth(twoMonthsAgo.getMonth() - 2);
                let dataChanged = false;
                for (const dateKey in state.logData) {
                    if (new Date(dateKey) < twoMonthsAgo) {
                        delete state.logData[dateKey];
                        dataChanged = true;
                    }
                }
                if (dataChanged) saveData();
            }

            function loadData() {
                const savedData = localStorage.getItem('aquariumLog_monthly_v6');
                state.logData = savedData ? JSON.parse(savedData) : {};
                state.firstLogDate = findFirstLogDate();
                pruneOldData();
            }

            function saveData() {
                localStorage.setItem('aquariumLog_monthly_v6', JSON.stringify(state.logData));
                if (!state.firstLogDate) {
                    state.firstLogDate = findFirstLogDate();
                }
            }

            function getDayLog(date) {
                const key = toISODateString(date);
                if (!state.logData[key]) {
                    state.logData[key] = { doses: {}, wq: {}, wc: 0, algaePresent: false };
                }
                return state.logData[key];
            }
            
            function isLogEmpty(log) {
                if (!log) return true;
                const dosesEmpty = !log.doses || Object.keys(log.doses).length === 0;
                const wqEmpty = !log.wq || Object.keys(log.wq).length === 0;
                const wcEmpty = !log.wc || log.wc === 0;
                const algaeEmpty = !log.algaePresent;
                return dosesEmpty && wqEmpty && wcEmpty && algaeEmpty;
            }
            
            function resetSelectedDayData() {
                const key = toISODateString(state.selectedDate);
                delete state.logData[key];
                saveData();
                state.firstLogDate = findFirstLogDate();
                render();
            }

            // --- Logic Engines ---
            function getSystemRecommendations(date) {
                const recommendations = [];
                const log = getDayLog(date);

                if (toISODateString(date) === toISODateString(TODAY)) {
                    let wqTestFound = false;
                    for (let i = 0; i < 7; i++) {
                        const checkDate = new Date(TODAY);
                        checkDate.setDate(TODAY.getDate() - i);
                        if (getDayLog(checkDate).wq && Object.keys(getDayLog(checkDate).wq).length > 0) {
                            wqTestFound = true;
                            break;
                        }
                    }
                    if (!wqTestFound) {
                        recommendations.push({ title: 'System Check Recommended', message: 'No water quality test has been logged in the past 7 days. Regular testing is advised to ensure a stable environment.' });
                    }
                }

                if (log.algaePresent) {
                     recommendations.push({ title: 'Algae Alert Active', message: 'Lean dosing protocol engaged. Consider reducing lighting period by 1-2 hours and ensure good water flow.' });
                }
                return recommendations;
            }

            function getWaterQualityRecommendations(date) {
                const actions = [];
                const log = getDayLog(date);
                const wq = log.wq || {};

                if (parseFloat(wq.Ammonia) >= 0.25 || parseFloat(wq.Nitrite) >= 0.25) {
                    actions.push({ type: 'priority', title: 'Priority Alert: Toxins Detected', message: 'Perform an immediate 50% water change. Dose Prime for the full tank volume to detoxify.', suppressFertilizers: true });
                }
                if (parseFloat(wq.Nitrate) >= 40) {
                    actions.push({ type: 'recommendation', title: 'High Nitrates Advisory', message: 'Consider a water change to lower nitrates. Pause Nitrogen dosing if levels remain high.', suppressNitrogen: true });
                }
                if (parseFloat(wq.pH) <= 6.4) {
                    actions.push({ type: 'recommendation', title: 'Low pH Advisory', message: 'pH is low. Consider using Alkaline Buffer to gradually raise pH towards the target range (6.8-7.6).' });
                }
                const khInDkh = parseFloat(wq.KH) / MG_PER_L_TO_DH;
                if (wq.KH !== undefined && khInDkh <= 2) {
                    actions.push({ type: 'recommendation', title: 'Low Alkalinity Advisory', message: 'KH is low, which can lead to pH swings. A dose of Alkaline Buffer will raise KH by approx. 2.8 dKH.' });
                }
                return actions;
            }

            function getDosingRecommendations(date, wqActions) {
                let recommendations = {};
                const log = getDayLog(date);
                const isWC = log.wc > 0;
                const suppressFertilizers = wqActions.some(a => a.suppressFertilizers);
                const suppressNitrogen = wqActions.some(a => a.suppressNitrogen);

                const isNewTank = !state.firstLogDate || (TODAY - state.firstLogDate) / (1000 * 60 * 60 * 24) < 21;
                const algaePresent = log.algaePresent;
                
                const yesterday = new Date(date);
                yesterday.setDate(date.getDate() - 1);
                const yesterdayLog = getDayLog(yesterday);

                TREATMENTS.forEach(t => {
                    if (suppressFertilizers && ['Flourish', 'Iron', 'Nitrogen'].includes(t.name)) return;
                    if (suppressNitrogen && t.name === 'Nitrogen') return;

                    let shouldDose = false, reason = '';
                    if (log.doses[t.name]) {
                        recommendations[t.name] = { shouldDose: false, reason: `Logged on ${formatDate(date)}`, isDone: true };
                        return;
                    }

                    const dayOfWeek = date.getDay();

                    switch(t.schedule.type) {
                        case 'water_change': if (isWC) { shouldDose = true; reason = `For ${log.wc}L Water Change`; } break;
                        case 'water_change_monthly':
                            if (isWC) {
                                let dosedInLast30Days = false;
                                for (let i = 1; i <= 30; i++) {
                                    const checkDate = new Date(date);
                                    checkDate.setDate(date.getDate() - i);
                                    if(getDayLog(checkDate).doses[t.name]) {
                                        dosedInLast30Days = true;
                                        break;
                                    }
                                }
                                if (!dosedInLast30Days) {
                                    shouldDose = true;
                                    reason = 'Monthly dose with water change';
                                }
                            }
                            break;
                        case 'alternate_day': if (!yesterdayLog.doses[t.name]) { shouldDose = true; reason = 'Alternate Day Dosing'; } break;
                        case 'weekly':
                            if (algaePresent && ['Nitrogen', 'Iron'].includes(t.name)) {
                                reason = 'Paused due to algae alert';
                                break;
                            }
                            if (algaePresent && t.name === 'Flourish') {
                                let dosedInLast10Days = false;
                                for (let i = 1; i <= 10; i++) {
                                     const checkDate = new Date(date);
                                     checkDate.setDate(date.getDate() - i);
                                     if(getDayLog(checkDate).doses[t.name]) {
                                         dosedInLast10Days = true;
                                         break;
                                     }
                                }
                                if (!dosedInLast10Days) {
                                    shouldDose = true;
                                    reason = 'Lean dosing schedule (1/10 days)';
                                }
                            } else if (t.schedule.days.includes(dayOfWeek)) {
                                shouldDose = true; reason = `Scheduled for ${DAYS[dayOfWeek]}`;
                            } else if (toISODateString(date) === toISODateString(TODAY) && !isNewTank) {
                                let missedDay = null;
                                for (let i = 1; i < 7; i++) {
                                    const checkDate = new Date(date);
                                    checkDate.setDate(date.getDate() - i);
                                    if (t.schedule.days.includes(checkDate.getDay())) {
                                        if (!getDayLog(checkDate).doses[t.name]) missedDay = checkDate;
                                        break; 
                                    }
                                }
                                if(missedDay){
                                    reason = `Missed task from ${DAYS[missedDay.getDay()]}`;
                                    shouldDose = true;
                                }
                            }
                            break;
                        case 'manual':
                             if (t.name === 'Alkaline Buffer') {
                                const needsBuffer = wqActions.some(a => a.title.includes('Low pH') || a.title.includes('Low Alkalinity'));
                                if (needsBuffer) {
                                    shouldDose = true;
                                    reason = 'Low pH or KH detected';
                                }
                            }
                            break;
                    }
                    if (shouldDose) recommendations[t.name] = { shouldDose, reason, isDone: false };
                });

                // --- Conflict Resolution for Flourish & Trace ---
                const flourishRec = recommendations['Flourish'];
                const traceRec = recommendations['Trace'];

                if (flourishRec && flourishRec.shouldDose && yesterdayLog.doses['Trace']) {
                    delete recommendations['Flourish'];
                }
                if (traceRec && traceRec.shouldDose && yesterdayLog.doses['Flourish']) {
                     delete recommendations['Trace'];
                }
                 if (flourishRec && flourishRec.shouldDose && traceRec && traceRec.shouldDose) {
                    // If both are somehow recommended, prioritize the one originally scheduled for today
                    const flourishScheduled = TREATMENTS.find(t=>t.name==='Flourish').schedule.days.includes(date.getDay());
                    if (flourishScheduled) {
                        delete recommendations['Trace'];
                    } else {
                        delete recommendations['Flourish'];
                    }
                }

                return recommendations;
            }
            
            // --- Gemini API Integration ---
            function getWqValueForPrompt(log, key) {
                return log.wq && log.wq[key] !== undefined && log.wq[key] !== 'Not Tested' ? log.wq[key] : 'Not Tested';
            }

            async function getGeminiAnalysis() {
                const selectedLog = getDayLog(state.selectedDate);
                let promptHistory = `Historical Data (last 7 logs):\n`;
                for(let i=1; i<=7; i++){
                    const pastDate = new Date(state.selectedDate);
                    pastDate.setDate(pastDate.getDate() - i);
                    const pastLog = getDayLog(pastDate);
                    const doses = pastLog.doses ? Object.keys(pastLog.doses).join(', ') : 'None';
                    promptHistory += `- ${toISODateString(pastDate)}: pH: ${getWqValueForPrompt(pastLog, 'pH')}, Ammonia: ${getWqValueForPrompt(pastLog, 'Ammonia')}, Nitrite: ${getWqValueForPrompt(pastLog, 'Nitrite')}, Nitrate: ${getWqValueForPrompt(pastLog, 'Nitrate')}, GH: ${getWqValueForPrompt(pastLog, 'GH')}, KH: ${getWqValueForPrompt(pastLog, 'KH')}, Doses: ${doses || 'None'}\n`;
                }

                const prompt = `You are an expert aquarist analysing data for a 3-gallon planted nano tank with Neocaridina shrimp, Nerite and Ramshorn snails.
                Today's Date: ${toISODateString(state.selectedDate)}
                Today's Water Parameters:
                - pH: ${getWqValueForPrompt(selectedLog, 'pH')}
                - Ammonia: ${getWqValueForPrompt(selectedLog, 'Ammonia')} ppm
                - Nitrite: ${getWqValueForPrompt(selectedLog, 'Nitrite')} ppm
                - Nitrate: ${getWqValueForPrompt(selectedLog, 'Nitrate')} ppm
                - GH: ${getWqValueForPrompt(selectedLog, 'GH') || 'Not Tested'} mg/L
                - KH: ${getWqValueForPrompt(selectedLog, 'KH') || 'Not Tested'} mg/L
                - TA: ${getWqValueForPrompt(selectedLog, 'TA') || 'Not Tested'} ppm
                Today's Actions:
                - Water Added: ${selectedLog.wc} litres
                - Doses Logged: ${Object.keys(selectedLog.doses).join(', ') || 'None'}
                - Algae Present: ${selectedLog.algaePresent ? 'Yes' : 'No'}
                ${promptHistory}
                Based on this data, provide a concise, bulleted analysis and 1-2 actionable recommendations. Be encouraging and focus on the most important next steps. Adopt a friendly ship AI: functional, and keep it very short and brief.`;

                renderAnalysisResult('<p class="loading-analysis">Analysing system data...</p>');

                try {
                    let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                    const payload = { contents: chatHistory };
                    const apiKey = "AIzaSyBQF2vNPby18Salq5AkLM8O3WxUOjYRYRU"; // Remember to add your restricted API key here
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`API Error: ${response.statusText}`);

                    const result = await response.json();
                    if (result.candidates && result.candidates[0].content.parts[0].text) {
                        const text = result.candidates[0].content.parts[0].text;
                        const formattedText = text.replace(/\*/g, '').replace(/(\r\n|\n|\r)/gm, "<br>");
                        renderAnalysisResult(formattedText);
                    } else {
                        renderAnalysisResult('<p class="text-red-700">Could not get a valid analysis. Please try again.</p>');
                    }
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    renderAnalysisResult('<p class="text-red-700">Error connecting to analysis service. Check console for details.</p>');
                }
            }

            // --- Render Functions ---
            function updateStreakCounter() {
                let streak = 0;
                let checkDate = new Date(TODAY);
                while (true) {
                    const log = getDayLog(checkDate);
                    if (isLogEmpty(log)) {
                        if (toISODateString(checkDate) === toISODateString(TODAY)) {
                             checkDate.setDate(checkDate.getDate() - 1);
                             continue;
                        }
                        break;
                    }
                    streak++;
                    checkDate.setDate(checkDate.getDate() - 1);
                }
                elements.streakCounter.textContent = `LOG STREAK: ${streak} DAYS`;
            }

            function renderAnalysisResult(htmlContent) {
                 elements.analysisContainer.innerHTML = `
                    <div class="retro-panel p-4">
                        <h2 class="text-xl font-bold mb-3 text-center text-zinc-900">AI Health Analysis</h2>
                        <div class="text-zinc-700 space-y-2">${htmlContent}</div>
                    </div>
                `;
            }

            function renderCalendar() {
                elements.monthYearTitle.textContent = state.currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                elements.calendarGrid.innerHTML = '';
                
                const month = state.currentDate.getMonth();
                const year = state.currentDate.getFullYear();
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();

                const dayHeaders = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
                elements.calendarGrid.innerHTML += dayHeaders.map(d => `<div class="font-bold text-amber-600">${d}</div>`).join('');

                for (let i = 0; i < firstDay; i++) {
                    elements.calendarGrid.innerHTML += '<div></div>';
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    const dateStr = toISODateString(date);
                    const log = state.logData[dateStr]; 
                    const isToday = dateStr === toISODateString(TODAY);
                    const isSelected = dateStr === toISODateString(state.selectedDate);

                    let dots = '';
                    if (log && log.doses && Object.keys(log.doses).length > 0) dots += '<div class="log-dot dot-dose"></div>';
                    if (log && log.wc > 0) dots += '<div class="log-dot dot-wc"></div>';
                    if (log && log.wq && Object.keys(log.wq).length > 0) dots += '<div class="log-dot dot-wq"></div>';
                    
                    elements.calendarGrid.innerHTML += `
                        <button data-date="${dateStr}" class="day-cell retro-btn no-light p-2 rounded-md ${isToday ? 'today' : ''} ${isSelected ? 'selected' : ''}">
                            <span>${i}</span>
                            <div class="log-dots">${dots}</div>
                        </button>
                    `;
                }
            }
            
            function renderPanels() {
                const log = getDayLog(state.selectedDate);

                elements.algaeBtn.classList.toggle('active', !!log.algaePresent);

                elements.wqInputs.innerHTML = Object.entries(WQ_PARAMS).map(([key, param]) => {
                    const savedValue = log.wq[key] ?? 'Not Tested';
                    const optionsHTML = param.values.map(v => `<option value="${v}" ${v === savedValue ? 'selected' : ''}>${v}</option>`).join('');
                    return `
                        <div>
                            <label for="wq-${key}" class="block mb-1 font-medium text-zinc-600 text-sm">${param.label} ${param.unit ? `(${param.unit})` : ''}</label>
                            <select id="wq-${key}" data-key="${key}" class="wq-select retro-btn w-full p-2">
                                ${optionsHTML}
                            </select>
                        </div>
                    `;
                }).join('');

                elements.advancedWqInputs.innerHTML = Object.entries(ADVANCED_WQ_PARAMS).map(([key, param]) => {
                    const savedValue = log.wq[key] || '';
                    const conversion = (key === 'GH' || key === 'KH') && savedValue ? `(≈ ${(savedValue / MG_PER_L_TO_DH).toFixed(1)} °d)` : '';
                    return `
                        <div class="flex flex-col">
                            <label for="wq-${key}" class="block mb-1 font-medium text-zinc-600 text-sm">${param.label} (${param.unit})</label>
                            <div class="flex items-center gap-2">
                                <input type="number" id="wq-${key}" data-key="${key}" value="${savedValue}" class="wq-input retro-btn w-full p-2 text-center" placeholder="N/A">
                                <span id="${key}-conversion" class="text-sm text-zinc-500 w-20">${conversion}</span>
                            </div>
                        </div>
                    `;
                }).join('');
                
                elements.wcInput.value = log.wc > 0 ? log.wc : '';
                const dayString = toISODateString(state.selectedDate) === toISODateString(TODAY) ? "Today" : `on ${DAYS[state.selectedDate.getDay()]}`;
                elements.waterChangeTitle.textContent = `Water Change ${dayString}`;
                elements.dosingDayTitle.textContent = `Tasks for ${formatDate(state.selectedDate)}`;

                const systemRecs = getSystemRecommendations(state.selectedDate);
                const wqActions = getWaterQualityRecommendations(state.selectedDate);
                const recommendations = getDosingRecommendations(state.selectedDate, wqActions);
                
                elements.systemRecommendations.innerHTML = systemRecs.map(rec => `
                     <div class="retro-panel p-4 recommendation-action">
                        <h3 class="font-bold text-lg" style="color: #D87D25;">${rec.title}</h3>
                        <p class="text-zinc-700">${rec.message}</p>
                    </div>
                `).join('');

                elements.priorityActions.innerHTML = wqActions.map(a => `
                    <div class="retro-panel p-4 ${a.type === 'priority' ? 'priority-action' : 'recommendation-action'}">
                        <h3 class="font-bold text-lg ${a.type === 'priority' ? 'text-red-700' : 'text-amber-700'}">${a.title}</h3>
                        <p class="text-zinc-700">${a.message}</p>
                    </div>
                `).join('');

                elements.cards.innerHTML = '';
                let cardsGenerated = 0;
                Object.entries(recommendations).forEach(([name, rec]) => {
                    cardsGenerated++;
                    const treatment = TREATMENTS.find(t => t.name === name);
                    const dosage = treatment.dose(log.wc > 0, log.wc);
                    elements.cards.innerHTML += `
                        <div class="retro-panel p-4 flex flex-col sm:flex-row items-center justify-between gap-3">
                            <div class="flex-grow">
                                <h3 class="text-xl font-bold text-zinc-800">${treatment.name}</h3>
                                <p class="text-lg font-bold" style="color: #D87D25;">${dosage}</p>
                                <p class="text-sm text-zinc-500">${rec.reason}</p>
                            </div>
                            <div class="flex-shrink-0 w-full sm:w-40">
                                <button data-treatment="${name}" class="dose-btn retro-btn w-full justify-center ${rec.isDone ? 'active' : ''}">
                                    <span>${rec.isDone ? 'Logged' : 'Log Task'}</span>
                                </button>
                            </div>
                        </div>
                    `;
                });

                if (cardsGenerated === 0 && wqActions.length === 0 && systemRecs.length === 0) {
                    elements.cards.innerHTML = `<div class="retro-panel text-center text-zinc-500 p-8">
                        <h3 class="text-xl font-semibold text-zinc-800">No tasks scheduled for ${DAYS[state.selectedDate.getDay()]}.</h3>
                    </div>`;
                }
            }

            function renderChemicalReference() {
                elements.chemRefContent.innerHTML = TREATMENTS.map(t => `
                    <div>
                        <h3 class="font-bold text-lg text-zinc-800">${t.name}</h3>
                        <p class="text-zinc-600">${t.directions}</p>
                    </div>
                `).join('');
            }

            function render() {
                updateStreakCounter();
                renderCalendar();
                renderPanels();
            }

            // --- Event Listeners ---
            function handleMonthChange(direction) {
                state.currentDate.setMonth(state.currentDate.getMonth() + direction);
                render();
            }

            elements.prevMonthBtn.addEventListener('click', () => handleMonthChange(-1));
            elements.nextMonthBtn.addEventListener('click', () => handleMonthChange(1));

            elements.calendarGrid.addEventListener('click', e => {
                const button = e.target.closest('.day-cell');
                if (button) {
                    state.selectedDate = new Date(button.dataset.date + 'T12:00:00');
                    elements.analysisContainer.innerHTML = ''; // Clear old analysis
                    render();
                }
            });

            elements.cards.addEventListener('click', e => {
                const button = e.target.closest('.dose-btn');
                if (button) {
                    const treatmentName = button.dataset.treatment;
                    const log = getDayLog(state.selectedDate);
                    log.doses[treatmentName] = !log.doses[treatmentName]; // Toggle the log
                    saveData();
                    render();
                }
            });

            elements.wcInput.addEventListener('change', e => {
                const log = getDayLog(state.selectedDate);
                log.wc = parseFloat(e.target.value) || 0;
                saveData();
                renderPanels();
            });
            
            elements.wqInputs.addEventListener('change', e => {
                if(e.target.matches('.wq-select')) {
                    const log = getDayLog(state.selectedDate);
                    const key = e.target.dataset.key;
                    const value = e.target.value;
                    if (value === 'Not Tested') {
                        delete log.wq[key];
                    } else {
                        log.wq[key] = value;
                    }
                    saveData();
                    render();
                }
            });

            elements.advancedWqInputs.addEventListener('change', e => {
                 if(e.target.matches('.wq-input')) {
                    const log = getDayLog(state.selectedDate);
                    const key = e.target.dataset.key;
                    const value = e.target.value;
                    
                    const conversionSpan = document.getElementById(`${key}-conversion`);
                    if (conversionSpan) {
                         if (value && (key === 'GH' || key === 'KH')) {
                            conversionSpan.textContent = `(≈ ${(value / MG_PER_L_TO_DH).toFixed(1)} °d)`;
                         } else {
                            conversionSpan.textContent = '';
                         }
                    }

                    if (value === '') {
                        delete log.wq[key];
                    } else {
                        log.wq[key] = value;
                    }
                    saveData();
                    render(); // Re-render to update recommendations
                }
            });

            elements.resetButton.addEventListener('click', () => {
                if (confirm(`Are you sure you want to erase the log for ${formatDate(state.selectedDate)}? This cannot be undone.`)) {
                    resetSelectedDayData();
                }
            });

            elements.chemRefToggle.addEventListener('click', () => {
                elements.chemRefContent.classList.toggle('hidden');
                elements.chemRefArrow.classList.toggle('rotate-180');
            });
            
            elements.logWqBtn.addEventListener('click', () => {
                elements.wqInputsContainer.classList.toggle('hidden');
                elements.logWqBtn.classList.toggle('active');
            });

            elements.algaeBtn.addEventListener('click', () => {
                const log = getDayLog(state.selectedDate);
                log.algaePresent = !log.algaePresent;
                saveData();
                render();
            });

            elements.analyzeBtn.addEventListener('click', getGeminiAnalysis);

            // --- Initialization ---
            loadData();
            renderChemicalReference();
            render();
        });
    </script>
</body>
</html>
